---
- name: Update APT cache
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install common packages
  ansible.builtin.apt:
    name:
       - curl
       - vim
       - git
       - htop
       - btop
       - net-tools
       - sudo
       - wget
       - ncdu
       - ca-certificates
       - ansible
       - screen
    state: present
    update_cache: yes

# ---------------------------
# SSH
# ---------------------------
- name: Ensure SSH directory exists
  file:
    path: "/home/{{ server_user }}/.ssh"
    state: directory
    owner: "{{ server_user }}"
    group: "{{ server_user }}"
    mode: '0700'

- name: Add public SSH key to authorized_keys
  authorized_key:
    user: "{{ server_user }}"
    key: "{{ vault_ssh_public_key }}"
    state: present

- name: Disable SSH root login
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^PermitRootLogin'
    line: 'PermitRootLogin no'
    state: present
  notify: Restart SSH

- name: Disable password authentication
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^PasswordAuthentication'
    line: 'PasswordAuthentication no'
    state: present
  notify: Restart SSH

- name: Allow only specific SSH users
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^AllowUsers'
    line: "AllowUsers {{ server_user }}"
    state: present
  notify: Restart SSH

# ---------------------------
# Firewall Setup (UFW)
# ---------------------------
- name: Ensure UFW is installed
  ansible.builtin.apt:
    name: ufw
    state: present
    update_cache: yes

- name: Reset UFW to defaults
  ansible.builtin.command:
    cmd: ufw --force reset

- name: Set default incoming policy to deny
  ufw:
    state: enabled
    policy: deny
    direction: incoming

- name: Set default outgoing policy to allow
  ufw:
    state: enabled
    policy: allow
    direction: outgoing

- name: Allow Docker public ports for allowed subnet
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
    src: "{{ subnet }}"
  loop: "{{ docker_public_ports }}"
  loop_control:
    loop_var: item
  vars:
    subnet: "{{ allowed_subnets | join(',') }}"  

- name: Allow Bare-Metal public ports for allowed subnet
  ufw:
    rule: allow
    port: "{{ item.port | default(item) }}"
    proto: "{{ item.proto | default('tcp') }}"
    src: "{{ subnet }}"
  loop: "{{ bare_metal_public_ports }}"
  loop_control:
    loop_var: item
  vars:
    subnet: "{{ allowed_subnets | join(',') }}"

- name: Allow selected ports for 10.0.10.0/24
  ufw:
    rule: allow
    port: "{{ item.port | default(item) }}"
    proto: "{{ item.proto | default('tcp') }}"
    src: 10.0.10.0/24
  loop:
    - 8123    # Homeassistant
    - { port: 53, proto: tcp }
    - { port: 53, proto: udp }

- name: Enable UFW logging
  ufw:
    logging: on

- name: Ensure UFW is enabled
  ufw:
    state: enabled

# ---------------------------
# auto-cpufreq
# ---------------------------
- name: Install dependencies for auto-cpufreq
  ansible.builtin.apt:
    name: git
    state: present
    update_cache: yes

- name: Clone auto-cpufreq repo
  ansible.builtin.git:
    repo: https://github.com/AdnanHodzic/auto-cpufreq.git
    dest: /opt/auto-cpufreq
    version: main
    force: yes

- name: Run auto-cpufreq installer
  ansible.builtin.command:
    cmd: ./auto-cpufreq-installer
    chdir: /opt/auto-cpufreq
  become: yes
  args:
    creates: /usr/bin/auto-cpufreq

- name: Ensure auto-cpufreq service is installed
  ansible.builtin.command:
    cmd: auto-cpufreq --install
  become: yes
  args:
    creates: /etc/systemd/system/auto-cpufreq.service

- name: Set CPU governor to powersave
  ansible.builtin.command:
    cmd: auto-cpufreq --force powersave
  become: yes